---
title: Galera Arbitrator Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ± & failover ÌÖåÏä§Ìä∏
date: 2024-10-10
draft: false
tags:
  - mariadb
  - galera
banner: 
cssclasses: 
description: 
permalink: 
aliases: 
completed:
---

## ‚öôÔ∏è ÌôòÍ≤Ω
- mariadb 10.8.3 (bitnami/mariadb-galera:10.8.3-debian-11-r0)
	- galera 26.22

## üí¨ Ïù¥Ïäà
Galera Cluster Í∞Ä Failover Î•º Ï≤òÎ¶¨ÌïòÍ∏∞ ÏúÑÌï¥ÏÑúÎäî ÏµúÏÜå 3Í∞úÏùò ÎÖ∏ÎìúÍ∞Ä ÌïÑÏöîÌïòÎã§. ÌïòÏßÄÎßå Î∂àÍ∞ÄÌîºÌïòÍ≤å 2Í∞ú ÎÖ∏ÎìúÏóêÏÑú Galera Cluster Î•º Ïù¥Ïö©Ìï¥ÏïºÌïòÎäî ÏÉÅÌô©Ïù¥ ÏÉùÍ≤® Galera Arbitrator Î•º ÌôúÏö©ÌïòÎäî Î∞©Î≤ïÏùÑ ÏïåÏïÑÎ≥¥ÏïòÎã§.  
Galera Cluster Îäî ÌÅ¥Îü¨Ïä§ÌÑ∞ Î∂ÑÏÇ∞Ïù¥ Ïù¥Î§ÑÏßÄÎ©¥ Quorum ÏïåÍ≥†Î¶¨Ï¶òÏùÑ Ïù¥Ïö©Ìï¥ Primary ÌÅ¥Îü¨Ïä§ÌÑ∞ÏôÄ non-Primary ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÑπÏÖòÏùÑ Íµ¨Î∂ÑÌïòÎäîÎç∞ Quorum ÏïåÍ≥†Î¶¨Ï¶òÏóê ÏùºÎ∞ò ÎÖ∏ÎìúÍ∞Ä ÏïÑÎãå Galera Arbitrator(Ïù¥Ìïò garbd) ÎÖ∏ÎìúÎèÑ Ï∞∏Ïó¨Í∞Ä Í∞ÄÎä•ÌïòÎã§Í≥† ÌïúÎã§.  

## üßó Ìï¥Í≤∞
### garbd Ïª®ÌÖåÏù¥ÎÑà Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
garbd Í≥µÏãù Ïª®ÌÖåÏù¥ÎÑà Ïù¥ÎØ∏ÏßÄÎäî ÏóÜÍ∏∞ ÎïåÎ¨∏Ïóê ÏÉùÏÑ±Ïù¥ ÌïÑÏöîÌñàÍ≥†, Í∏∞Ï°¥ mariadb Ïª®ÌÖåÏù¥ÎÑàÏôÄ Î≥ÑÎèÑÎ°ú Ï§ÄÎπÑÌï¥ÎèÑ ÎêòÍ≤†ÏßÄÎßå Íµ≥Ïù¥ Î∂ÑÎ¶¨Ìï† ÌïÑÏöîÍ∞Ä ÏóÜÎã§Î©¥ 1Í∞ú Ïù¥ÎØ∏ÏßÄÎ°ú ÌÜµÌï©ÏãúÌÇ§Í≥† command Î°ú ÏùºÎ∞ò galera node ÏôÄ garbd ÎÖ∏ÎìúÎ°ú Î∂ÑÎ¶¨ÌïòÎäî Î∞©Î≤ïÏùÑ ÌÉùÌñàÎã§.  
ÌòÑÏû¨ ÌÅ¥Îü¨Ïä§ÌÑ∞ Î≤ÑÏ†ÑÍ≥º ÏùºÏπòÌïòÎäî garbd Î•º ÏÑ§ÏπòÌïòÍ∏∞ ÏúÑÌï¥ [mariadb Í≥µÏãù Î¨∏ÏÑú](https://mariadb.com/kb/en/meta/galera-versions/)Î•º ÌôïÏù∏Ìï¥Î¥§ÏßÄÎßå Ï†ïÌôïÌïòÍ≤å ÏùºÏπòÌïòÎäî Î≤ÑÏ†ÑÏùÄ ÏóÜÏóàÏúºÎÇò Í∞àÎ†àÎùº major Î≤ÑÏ†ÑÏù¥ 26Ïù∏ Í≤ΩÏö∞ galera-arbitrator-4 Î•º ÏÑ§ÏπòÌïòÎäî Í≤ÉÏù¥ ÎßûÏùÑ Í≤ÉÏúºÎ°ú ÌåêÎã®ÎêòÏñ¥ ÏïÑÎûòÏôÄ Í∞ôÏù¥ Dockerfile ÎÇ¥Ïö©ÏùÑ Ï∂îÍ∞ÄÌñàÎã§.  

```dockerfile
RUN apt update --fix-missing && apt -y upgrade
RUN apt install -y --no-install-recommends software-properties-common &&\
    apt-add-repository 'deb https://releases.galeracluster.com/galera-4/ubuntu focal main' &&\
    apt install -y --no-install-recommends galera-arbitrator-4
```

Ìñ•ÌõÑ `https://releases.galeracluster.com/galera-4/ubuntu` Î¶¨Ìè¨Í∞Ä Ìï≠ÏÉÅ Ï°¥Ïû¨Ìï†ÏßÄÏôÄ ÏÉÅÏúÑÎ≤ÑÏ†ÑÏù¥ Í≥ÑÏÜçÌï¥ÏÑú ÌòÑÏû¨ Galera Cluster Î•º ÏßÄÏõêÌï†ÏßÄ Í≥†ÎØºÏä§ÎüΩÍ∏¥ ÌïòÏßÄÎßå ÎÇòÏ§ëÏóê Í≥†ÎØºÌïòÍ∏∞Î°ú ÌñàÎã§.  

> [!NOTE] 
> galera-arbitrator-3 ÏùÑ ÏÑ§ÏπòÌïòÎ©¥ ÏïÑÎûòÏôÄ Í∞ôÏùÄ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïúÎã§.  
> 2024-10-10 13:01:02.729 FATAL: ./gcs/src/gcs_group.cpp:group_check_proto_ver():258: Group requested gcs_proto_ver: 2, max supported by this node: 0.Upgrade the node before joining this group.Need to abort.
2024-10-10 13:01:02.729  INFO: garbd: Terminated.
> 

### garbd ÏòµÏÖò ÏÑ§Ï†ï
[Í∞àÎ†àÎùº Í≥µÏãùÎ¨∏ÏÑú](https://galeracluster.com/library/documentation/arbitrator.html)Î•º ÌôïÏù∏Ìï¥Î≥¥Î©¥ ÏòµÏÖòÏùÑ ÏßÅÏ†ë command Ïóê Ï∂îÍ∞ÄÌï¥Ï£ºÎäî Î∞©Î≤ïÍ≥º config ÌååÏùºÏùÑ Ïù¥Ïö©ÌïòÎäî Î∞©Î≤ïÏù¥ ÏûàÏóàÎã§.  

#### command Î∞©Ïãù

```yaml
# docker-compose.yml
 command:
 - garbd
 - --name=garbd-test-2
 - --group=my_galera
 - --address=gcomm://172.45.0.2:34567,172.45.0.3:34567
 - --log=/var/log/mysql/garbd.log
 - --options="base_dir=/bitnami/mariadb"
```

#### config Î∞©Ïãù

```yaml
# docker-compose.yml
command: garbd -c /path/to/arbitrator.config
```

```bash
# arbitrator.config
name=garbd-test-2
group=my_galera
address=gcomm://172.45.0.2:34567,172.45.0.3:34567
log=/var/log/mysql/garbd.log
options="base_dir=/bitnami/mariadb"
```

### failover ÌôïÏù∏
garbd ÎÖ∏ÎìúÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ïã§ÌñâÎêòÎ©¥ wsrep_cluster_size Ïù¥ 1 Ï¶ùÍ∞ÄÌïòÍ≥† Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÌÅ¥Îü¨Ïä§ÌÑ∞Ïóê join Ìïú Í≤ÉÏúºÎ°ú Î≥¥Ïù∏Îã§. ÌïòÏßÄÎßå Ïù¥Ï†ïÎèÑÎ°úÎäî garbd Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÎèôÏûëÌïòÎäîÏßÄ ÌåêÎã®ÌïòÍ∏∞Í∞Ä ÎÇúÍ∞êÌïòÎã§. Í∑∏Î†áÍ∏∞ÎïåÎ¨∏Ïóê Ïù∏ÏúÑÏ†ÅÏúºÎ°ú Ïû•Ïï†Î•º Î∞úÏÉùÏãúÌÇ§Í≥† garbd ÎÖ∏Îìú Ïú†Î¨¥Ïóê Îî∞Î•∏ failover Ï≤òÎ¶¨ Ïó¨Î∂ÄÎ•º ÌååÏïÖÌñàÎã§.   

#### ÌÖåÏä§Ìä∏ Î∞©Ïãù
galera ÎÖ∏ÎìúÏôÄ garbd ÎÖ∏Îìú Î™®Îëê ÎèÑÏª§ Ïª®ÌÖåÏù¥ÎÑàÎ°ú Íµ¨ÏÑ±ÎêòÏñ¥ ÏûàÍ∏∞ ÎïåÎ¨∏Ïóê Î¨ºÎ¶¨Ï†ÅÏúºÎ°ú ÎÑ§Ìä∏ÏõåÌÅ¨ Îã®Ï†àÏùÑ ÏãúÌÇ§Í∏∞Îäî Ïñ¥Î†µÍ≥† `docker network disconnect` Î™ÖÎ†πÏñ¥Î•º ÏÇ¨Ïö©Ìï¥ÏÑú ÎÖ∏ÎìúÍ∞Ñ ÎÑ§Ìä∏ÏõåÌÅ¨Î•º Îã®Ï†àÏãúÏº∞Îã§. Ïù¥Î†áÍ≤å ÎêòÎ©¥ Í∞Å ÎÖ∏ÎìúÍ∞Ä Í≥ÑÏÜçÌï¥ÏÑú Ïã§ÌñâÏ§ëÏù¥ÏßÄÎßå ÏÑúÎ°ú ÌÜµÏã†Ïù¥ ÎêòÏßÄ ÏïäÎäî ÏÉÅÌÉú(split)Í∞Ä Î∞úÏÉùÌïúÎã§.  

```bash
# ÎÑ§Ìä∏ÏõåÌÅ¨ Îã®Ï†à
docker network disconnect garbd-test_galera-net garbd-test-0
# Ï†ïÏÉÅÌôî
docker network connect garbd-test_galera-net garbd-test-0
```

> [!NOTE]
> docker stop ÏúºÎ°ú Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï†ïÏÉÅ Ï¢ÖÎ£åÌï† Í≤ΩÏö∞ 1Í∞ú ÎÖ∏ÎìúÎßå ÎÇ®ÎçîÎùºÎèÑ Ìä∏ÎûúÏ†ùÏÖòÏù¥ Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÎèôÏûëÌïúÎã§.


#### ÏºÄÏù¥Ïä§1 - galera ÎÖ∏Îìú 2, garbd ÎÖ∏Îìú 1

ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º init Ìïú ÏßÅÌõÑ ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÇ¨Ïù¥Ï¶àÏôÄ ÏÉÅÌÉúÎäî Îã§ÏùåÍ≥º Í∞ôÎã§.  

```sql
MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_size';
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 3     |
+--------------------+-------+

MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_status';
+----------------------+---------+
| Variable_name        | Value   |
+----------------------+---------+
| wsrep_cluster_status | Primary |
+----------------------+---------+
```

Ïù¥ ÏÉÅÌÉúÏóêÏÑú 0Î≤à ÎÖ∏Îìú(galera ÎÖ∏Îìú)Ïùò ÎÑ§Ìä∏ÏõåÌÅ¨Î•º Îã®Ï†àÏãúÌÇ®Îã§.  

```bash
docker network disconnect garbd-test_galera-net garbd-test-0
```

1Î≤à ÎÖ∏ÎìúÏóêÏÑú ÌôïÏù∏Ìï¥Î≥¥Î©¥ 0Î≤à ÎÖ∏ÎìúÍ∞Ä Î∂ÑÎ¶¨ÎêòÏñ¥ ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÇ¨Ïù¥Ï¶àÍ∞Ä Ï§ÑÏóàÏßÄÎßå Primary ÏÑπÏÖòÏûÑÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÎã§.  

```sql
MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_size';
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 2     |
+--------------------+-------+

MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_status';
+----------------------+---------+
| Variable_name        | Value   |
+----------------------+---------+
| wsrep_cluster_status | Primary |
+----------------------+---------+
```

ÎïåÎ¨∏Ïóê Ìä∏ÎûúÏ†ùÏÖò Ï≤òÎ¶¨Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Í∞ÄÎä•ÌïòÎã§.  

```sql
MariaDB [(none)]> create database test4;
Query OK, 1 row affected (0.017 sec)
```

#### ÏºÄÏù¥Ïä§2 - galera ÎÖ∏Îìú 2, garbd ÎÖ∏Îìú 0

ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º init Ìïú ÏßÅÌõÑ ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÇ¨Ïù¥Ï¶àÏôÄ ÏÉÅÌÉúÎäî Îã§ÏùåÍ≥º Í∞ôÎã§.  

```sql
MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_size';
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 2     |
+--------------------+-------+

MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_status';
+----------------------+---------+
| Variable_name        | Value   |
+----------------------+---------+
| wsrep_cluster_status | Primary |
+----------------------+---------+
```

Ïù¥ ÏÉÅÌÉúÏóêÏÑú 0Î≤à ÎÖ∏Îìú(galera ÎÖ∏Îìú)Ïùò ÎÑ§Ìä∏ÏõåÌÅ¨Î•º Îã®Ï†àÏãúÌÇ®Îã§.  

```bash
docker network disconnect garbd-test_galera-net garbd-test-0
```

1Î≤à ÎÖ∏ÎìúÏóêÏÑú ÌôïÏù∏Ìï¥Î≥¥Î©¥ 0Î≤à ÎÖ∏ÎìúÍ∞Ä Î∂ÑÎ¶¨ÎêòÏñ¥ ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÇ¨Ïù¥Ï¶àÍ∞Ä Ï§ÑÏóàÍ≥† non-Primary ÏÑπÏÖòÏûÑÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÎã§. (split brain).   

```sql
MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_size';
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 1     |
+--------------------+-------+

MariaDB [(none)]> SHOW STATUS LIKE 'wsrep_cluster_status';
+----------------------+-------------+
| Variable_name        | Value       |
+----------------------+-------------+
| wsrep_cluster_status | non-Primary |
+----------------------+-------------+
```

Ïù¥ÌõÑ Ìä∏ÎûúÏ†ùÏÖò Ï≤òÎ¶¨Ïóê Ïò§Î•òÍ∞Ä Î∞úÏÉùÌï®ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÎã§.  

```sql
MariaDB [(none)]> create database test3;
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
```

## üé∏ Ï†ÑÏ≤¥ Ïä§ÌÅ¨Î¶ΩÌä∏
### docker-compose.yml
```yaml
networks:
  galera-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.45.0.0/24

services:
  garbd-test-0:
    container_name: garbd-test-0
    environment:
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: "yes"
      MARIADB_GALERA_CLUSTER_NAME: my_galera
      MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP: "yes"
      MARIADB_GALERA_MARIABACKUP_PASSWORD: '1234'
      MARIADB_GALERA_MARIABACKUP_USER: user1
      MARIADB_ROOT_PASSWORD: 1234
    hostname: garbd-test-0
    image: db-with-garbd/davinci:3.1
    ports:
    - 33123:3306
    volumes:
    - /etc/hosts:/etc/hosts:ro
    - /etc/localtime:/etc/localtime:ro
    - ./config/0:/opt/bitnami/mariadb/conf/bitnami:rw
    - ./log/0:/var/log/mysql:rw
    - ./data/0:/bitnami/mariadb:rw
    networks:
      galera-net:
        ipv4_address: 172.45.0.2

  garbd-test-1:
    container_name: garbd-test-1
    environment:
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: "yes"
      MARIADB_GALERA_CLUSTER_NAME: my_galera
      MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP: "yes"
      MARIADB_GALERA_MARIABACKUP_PASSWORD: '1234'
      MARIADB_GALERA_MARIABACKUP_USER: user1
      MARIADB_ROOT_PASSWORD: 1234
    hostname: garbd-test-1
    image: db-with-garbd/davinci:3.1
    volumes:
    - /etc/hosts:/etc/hosts:ro
    - /etc/localtime:/etc/localtime:ro
    - ./config/1:/opt/bitnami/mariadb/conf/bitnami:rw
    - ./log/1:/var/log/mysql:rw
    - ./data/1:/bitnami/mariadb:rw
    networks:
      galera-net:
        ipv4_address: 172.45.0.3

  garbd-test-2:
    container_name: garbd-test-2
    environment:
      MARIADB_GALERA_CLUSTER_NAME: my_galera
    hostname: garbd-test-2
    image: db-with-garbd/davinci:3.1
    volumes:
    - /etc/hosts:/etc/hosts:ro
    - /etc/localtime:/etc/localtime:ro
    - ./config/2:/opt/bitnami/mariadb/conf/bitnami:rw
    - ./log/2:/var/log/mysql:rw
    - ./data/2:/bitnami/mariadb:rw
    command: garbd -c /opt/bitnami/mariadb/conf/bitnami/arbitrator.config

    networks:
      galera-net:
        ipv4_address: 172.45.0.4
```

###  Dockerfile
```dockerfile
FROM bitnami/mariadb-galera:10.8.3-debian-11-r0

USER root

# ÌïÑÏöî Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
RUN apt update --fix-missing && apt -y upgrade
RUN apt install -y --no-install-recommends apt-utils sudo vim git procps wget curl net-tools rsync progress screen zsh locales software-properties-common && \
    apt-add-repository 'deb https://releases.galeracluster.com/galera-4/ubuntu focal main' &&\
    apt install -y --no-install-recommends galera-arbitrator-4 &&\
    apt autoremove -y && apt autoclean -y && \
    rm -rf /var/lib/apt/lists/* && \
    localedef -f UTF-8 -i ko_KR ko_KR.UTF-8

# ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï
ENV LANGUAGE ko_KR.UTF-8
ENV LANG ko_KR.UTF-8
ENV TZ "Asia/Seoul"

# alias ÏÑ§Ï†ï Ï∂îÍ∞Ä
RUN echo "alias ll='ls -alFh'" >> /etc/bash.bashrc && \
    echo "alias vi='vim'" >> /etc/bash.bashrc && \
    echo "alias grep='grep --color=auto'" >> /etc/bash.bashrc

RUN useradd -ms /bin/bash mysql
```

### config
```bash
# node0 - my_custom.cfg
[galera]
wsrep_cluster_address     = "gcomm://"
wsrep_node_address        = "172.45.0.2:34567"
wsrep_node_name           = garbd-test-0
wsrep_sst_auth            = user1:1234
wsrep_sst_method          = mariabackup
wsrep_sst_receive_address = "172.45.0.2:34566"
wsrep_provider_options    = "base_port=34567;ist.recv_addr=172.45.0.2:34568;gcache.recover=yes"
```

```bash
# node1 - my_custom.cfg
[galera]
wsrep_cluster_address     = "gcomm://172.45.0.2:34567"
wsrep_node_address        = "172.45.0.3:34567"
wsrep_node_name           = garbd-test-1
wsrep_sst_auth            = user1:1234
wsrep_sst_method          = mariabackup
wsrep_sst_receive_address = "172.45.0.3:34566"
wsrep_provider_options    = "base_port=34567;ist.recv_addr=172.45.0.3:34568;gcache.recover=yes"
```

```bash
# node2 - arbitrator.config
name=garbd-test-2
group=my_galera
address=gcomm://172.45.0.2:34567,172.45.0.3:34567
log=/var/log/mysql/garbd.log
options="base_dir=/bitnami/mariadb"
```

## üöÄ Ï∞∏Í≥†
- [https://galeracluster.com/library/documentation/weighted-quorum.html](https://galeracluster.com/library/documentation/weighted-quorum.html)
- [https://github.com/panubo/docker-mariadb-galera/blob/master/10.2/Dockerfile](https://github.com/panubo/docker-mariadb-galera/blob/master/10.2/Dockerfile)



